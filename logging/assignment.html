<!doctype html>

<html>

	<head>
		<meta charset="UTF-8">
		<title>Select an assignment</title>
		<style>
			.hidden {
				display: none;
			}
			.hint {
				color: #888;
				font-style: italic;
			}
			#display-id {
				font-weight: bold;
			}
		</style>
		<script type="text/javascript" src="config.js"></script>
		<script type="text/javascript" src="jquery-3.1.1.min.js"></script>
		<script type="text/javascript" src="jquery.cookie.js"></script>
	</head>

	<body>
		<h1>Select the assignment you're working on.</h1>

		<div id="form-id">
			<form>
				Unity ID:
				<input id="input-id" name="id" placeholder="e.g. jtsmith2"
					required pattern="[A-Za-z0-9_]+">
				<br />
				<span class="hint">
					This is the part of your email before @ncsu.
				</span>
				<div id="confirm-new" class="hidden">
					<p class="alert">
						This is the first time we've seen a user with
						the ID <span id="display-id"></span>.
						If you're a new user, please check the box
						below. If not, please double-check your ID.
					</p>
					<input id="input-new" type="checkbox" name="new"
						value="true">
					I'm a new user.
				</div>
				<br />
				<button type="submit">Submit</button>
			</form>
		</div>

		<div id="form-assignment" class="hidden">
			<form action="../snap.html" method="get">
				Assignment:
				<select id="assignment" name="assignment"></select>
				<button type="submit">Go</button>
			</form>
		</div>

		<br /><br /><br />
		<div id="logout" class="hidden">
			<a href="#" onclick="logout()">[Logout]</a>
		</div>

		<script type="text/javascript">
			var assignments = window.assignments;
			var select = document.getElementById("assignment");
			for (var key in assignments) {
				if (assignments.hasOwnProperty(key)) {
					if (key == "test" || key == "view") continue;
					var option = document.createElement("option");
					option.text = assignments[key].name || assignments[key];
					option.value = key;
					select.add(option);
				}
			}

			if (!navigator.cookieEnabled) {
				// TODO: handle cookies not available!
				// There's no other way to pass this information from one page
				// to another, so we'll need them enabled. Again, maybe
				// have an emergency option to disable
			}

			function setUserID(id) {
				if (!id) return;
				window.userID = id;
				$('#form-id').addClass('hidden');
				$('#form-assignment').removeClass('hidden');
				$('#logout').removeClass('hidden');
			}

			function logout() {
				$.removeCookie('userID');
				$('#form-id').removeClass('hidden');
				$('#confirm-new').addClass('hidden');
				$('#input-new').prop('checked', false);
				$('#form-assignment').addClass('hidden');
				$('#logout').addClass('hidden');
			}

			setUserID( $.cookie('userID'));

			$('#form-id').submit(function() {
				var id = $('#input-id').val();
				$('#display-id').html(id);
				$.post('login.php', {
					'id': id,
					'new': $('#input-new').prop('checked'),
				}, function(data, status) {
					var response = JSON.parse(data);
					if (response.newUser) {
						$('#confirm-new').removeClass('hidden');
						return;
					}
					setUserID(response.userID);
				}).fail(function() {
					// TODO: Handle this error
					// The user should be able proceed anyway after
					// trying again?
				});
				return false;
			});

			if (!window.requireLogin) {
				setUserID('none');
				$('#logout').addClass('hidden');
			}
		</script>
	</body>
</html>
